/*! pica - v0.1.0 - 2013-01-28
* https://github.com/unepwcmc/pica.js
* Copyright (c) 2013 UNEP-WCMC; */
window.Pica||(window.Pica={}),Pica.Events=function(){function e(){}return e.prototype.on=function(e,t){var n;return this.events||(this.events={}),(n=this.events)[e]||(n[e]=[]),this.events[e].push(t)},e.prototype.off=function(e,t){var n,r,i,s,o,u;if(this.events==null)return;if(e==null)return this.events=[];if(this.events[e]!=null){if(t!=null){o=this.events[e],u=[];for(r=i=0,s=o.length;i<s;r=++i)n=o[r],n===t?(this.events[e].splice(r,1),u.push(r-=1)):u.push(void 0);return u}return delete this.events[e]}},e.prototype.trigger=function(e,t){var n,r,i,s,o;if(this.events!=null&&this.events[e]!=null){s=this.events[e],o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n.apply(this,[].concat(t)));return o}},e}();var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Model=function(e){function t(){return this["delete"]=__bind(this["delete"],this),this.fetch=__bind(this.fetch,this),this.save=__bind(this.save,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url=function(){},t.prototype.get=function(e){var t;return(t=this.attributes)==null&&(this.attributes={}),this.attributes[e]},t.prototype.set=function(e,t){var n;return(n=this.attributes)==null&&(this.attributes={}),this.attributes[e]=t,this.trigger("change")},t.prototype.sync=function(e){var t,n,r=this;e==null&&(e={}),t=e.success||function(){},e.success=function(e,n,i){return e.id!=null&&(r.parse(e),r.trigger("sync",r)),t(r,n,i)};if(e.type==="post"||e.type==="put")n=this.attributes,e.type==="post"&&(n=JSON.stringify(n));return e.type==="delete"&&(n=null),$.ajax($.extend(e,{contentType:"application/json",data:n}))},t.prototype.parse=function(e){var t,n,r;r=[];for(t in e)n=e[t],r.push(this.set(t,n));return r},t.prototype.save=function(e){return e==null&&(e={}),this.get("id")!=null?(e.url=this.url().read!=null?this.url().read:this.url(),e.type="put"):(e.url=this.url().create!=null?this.url().create:this.url(),e.type="post"),console.log("saving "+this.constructor.name+" "+this.get("id")),this.sync(e)},t.prototype.fetch=function(e){return e==null&&(e={}),e.url=this.url().read!=null?this.url().read:this.url(),console.log("fetching "+this.constructor.name+" "+this.get("id")),this.sync(e)},t.prototype["delete"]=function(e){var t,n=this;return e==null&&(e={}),e.url=this.url().read!=null?this.url().read:this.url(),e.type="delete",t=e.success,e.success=function(){return n.trigger("delete"),console.log("deleted "+n.constructor.name+" "+n.get("id")),t&&t(),n.off()},this.sync(e)},t}(Pica.Events);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};window.Pica||(window.Pica={}),Pica.Models={},Pica.Views={},Pica.Application=function(e){function t(e){this.config=e,this.parse=__bind(this.parse,this),Pica.config=this.config,$.support.cors=!0,$.ajaxSetup({headers:{"X-Magpie-ProjectId":Pica.config.projectId}}),this.layers=[],this.fetch()}return __extends(t,e),t.prototype.newWorkspace=function(){return this.currentWorkspace=new Pica.Models.Workspace},t.prototype.showTileLayers=function(){return new Pica.Views.ShowLayersView({app:this})},t.prototype.fetch=function(){return $.ajax({url:""+Pica.config.magpieUrl+"/projects/"+Pica.config.projectId+".json",type:"get",success:this.parse})},t.prototype.parse=function(e){var t,n;for(t in e)n=e[t],this[t]=n;return this.trigger("sync")},t}(Pica.Events);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Area=function(e){function t(e){this.save=__bind(this.save,this),this.polygons=[],this.set("name","My Lovely Area")}return __extends(t,e),t.prototype.setName=function(e){return this.set("name",e)},t.prototype.addPolygon=function(e){var t=this;return e.on("requestAreaId",function(e){return t.get("id")!=null?e.success(t):t.save(e)}),e.on("sync",function(){return t.fetch()}),e.on("delete",function(){return t.fetch()}),this.polygons.push(e),this.trigger("addedPolygon",e)},t.prototype.drawNewPolygonView=function(e){return this.currentPolygon=new Pica.Models.Polygon,this.addPolygon(this.currentPolygon),new Pica.Views.NewPolygonView({callbacks:e,polygon:this.currentPolygon})},t.prototype.drawNewCircleView=function(e){return this.currentPolygon=new Pica.Models.Polygon,this.addPolygon(this.currentPolygon),new Pica.Views.NewCircleView({callbacks:e,polygon:this.currentPolygon})},t.prototype.newUploadFileView=function(e){return new Pica.Views.UploadFileView({callbacks:e,area:this})},t.prototype.newShowAreaPolygonsView=function(){return new Pica.Views.ShowAreaPolygonsView({area:this})},t.prototype.url=function(){return{create:""+Pica.config.magpieUrl+"/workspaces/"+this.get("workspace_id")+"/areas_of_interest/",read:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("id")}},t.prototype.parse=function(e){var n,r,i,s,o,u,a,f,l,c;if(e.polygons!=null){this.polygons=[],l=e.polygons;for(o=0,a=l.length;o<a;o++)i=l[o],r=new Pica.Models.Polygon({attributes:i}),this.addPolygon(r);delete e.polygons}else{s=[],c=this.polygons;for(n=u=0,f=c.length;u<f;n=++u)r=c[n],r.get("id")==null&&s.push(r);this.polygons=s}return t.__super__.parse.apply(this,arguments)},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("workspace_id")!=null?t.__super__.save.call(this,e):this.trigger("requestWorkspaceId",{success:function(t,r,i){return n.set("workspace_id",t.get("id")),n.get("workspace_id")?n.save(e):e.error(n,{error:"Could not save workspace, so cannot save area"},i)},error:function(t,n,r){console.log("Unable to save area:"),console.log(arguments),console.log(t.status),console.log(t.statusText),console.log(t.responseText);if(e.error!=null)return e.error(t,n,{error:"Unable to obtain workspaceId, cannot save area",parentError:r})}})},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Polygon=function(e){function t(e){var t;e==null&&(e={}),this.save=__bind(this.save,this),this.attributes=e.attributes!=null?e.attributes:{},(t=this.attributes).geometry||(t.geometry={type:"Polygon"})}return __extends(t,e),t.prototype.isComplete=function(){return this.get("geometry").coordinates!=null},t.prototype.setGeomFromPoints=function(e){var t;return e=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push([t.lng,t.lat]);return i}(),e.push(e[0]),this.set("geometry",{type:"Polygon",coordinates:[e]})},t.prototype.setGeomFromCircle=function(e,t){return this.set("geometry",{type:"Circle",coordinates:[e.lng,e.lat],radius:t})},t.prototype.asLeafletArguments=function(){var e,t,n,r,i,s;e=[];if(this.get("geometry").type==="Polygon"){t=[];if(this.isComplete()){s=this.get("geometry").coordinates[0];for(r=0,i=s.length;r<i;r++)n=s[r],t.push(new L.LatLng(n[1],n[0]))}e.push(t)}else this.isComplete()?(n=this.get("geometry").coordinates,e=[new L.LatLng(n[1],n[0]),this.get("geometry").radius]):e=[[],0];return e},t.prototype.url=function(){return{read:""+Pica.config.magpieUrl+"/polygons/"+this.get("id"),create:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("area_id")+"/polygons"}},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("area_id")!=null?t.__super__.save.call(this,e):this.trigger("requestAreaId",{success:function(t,r,i){n.set("area_id",t.get("id"));if(n.get("area_id"))return n.save(e);if(e.error!=null)return e.error(n,{error:"Unable to get area id, so cannot save polygon"},i)},error:function(t,n,r){console.log("Unable to save polygon:"),console.log(arguments),console.log(t.status),console.log(t.statusText),console.log(t.responseText);if(e.error!=null)return e.error(t,n,{error:"Unable to obtain areaId, cannot save polygon",parentError:r})}})},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Workspace=function(e){function t(){this.save=__bind(this.save,this),this.attributes={},this.areas=[],this.currentArea=new Pica.Models.Area,this.addArea(this.currentArea)}return __extends(t,e),t.prototype.url=function(){return""+Pica.config.magpieUrl+"/workspaces"},t.prototype.addArea=function(e){var t=this;return e.on("requestWorkspaceId",function(e){return t.get("id")!=null?e.success(t):t.save(e)}),this.areas.push(e)},t.prototype.setCurrentArea=function(e){var t,n,r,i,s;i=this.areas,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t===e?s.push(this.currentArea=t):s.push(void 0);return s},t.prototype.setCurrentAreaById=function(e){var t,n,r,i,s;i=this.areas,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.get("id")===e?s.push(this.currentArea=t):s.push(void 0);return s},t.prototype.save=function(e){return t.__super__.save.call(this,e)},t}(Pica.Model),Pica.Views.NewCircleView=function(){function e(e){var t=this;e.callbacks!=null&&(this.successCallback=e.callbacks.success,this.errorCallback=e.callbacks.error),this.polygon=e.polygon,this.polygon.set("geometry",{type:"Circle"}),this.polygonDraw=new L.Circle.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:circle-created",function(e){return t.createPolygon(e.circ)})}return e.prototype.createPolygon=function(e){var t=this;return this.polygon.setGeomFromCircle(e.getLatLng(),e.getRadius()),this.polygon.save({success:function(){t.close();if(t.successCallback!=null)return t.successCallback()},error:function(e,n,r){t.close();if(t.errorCallback!=null)return t.errorCallback.apply(t,arguments)}})},e.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:circle-created")},e}(),Pica.Views.NewPolygonView=function(){function e(e){var t=this;e.callbacks!=null&&(this.successCallback=e.callbacks.success,this.errorCallback=e.callbacks.error),this.polygon=e.polygon,this.polygonDraw=new L.Polygon.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:poly-created",function(e){var n;return n=e.poly,t.createPolygon(n)})}return e.prototype.createPolygon=function(e){var t=this;return this.polygon.setGeomFromPoints(e.getLatLngs()),this.polygon.save({success:function(){t.close();if(t.successCallback!=null)return t.successCallback()},error:function(e,n,r){t.close();if(t.errorCallback!=null)return t.errorCallback.apply(t,arguments)}})},e.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:poly-created")},e}();var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Views.ShowAreaPolygonsView=function(e){function t(e){this.triggerPolyClick=__bind(this.triggerPolyClick,this),this.addPolygon=__bind(this.addPolygon,this),this.render=__bind(this.render,this),this.area=e.area,this.polysObserved=[],this.mapPolygons=[],this.area.on("sync",this.render),this.area.on("addedPolygon",this.addPolygon),this.render()}return __extends(t,e),t.prototype.render=function(){var e,t,n,r,i,s,o,u=this;this.removeAllPolygonsAndBindings(),s=this.area.polygons,o=[];for(r=0,i=s.length;r<i;r++){n=s[r];if(!n.isComplete())continue;t=function(e,t){var n;return n=function(t){return e.apply(this,t)},n.prototype=e.prototype,new n(t)},e=t(L[n.get("geometry").type],n.asLeafletArguments()).addTo(Pica.config.map),n.on("delete",function(){var t;return t=e,function(){return u.removeMapPolygonAndBindings(t)}}()),e.on("click",function(){var t,r;return r=n,t=e,function(e){return u.triggerPolyClick(r,e,t)}}()),o.push(this.mapPolygons.push(e))}return o},t.prototype.addPolygon=function(e){return e.on("change",this.render),this.polysObserved.push(e)},t.prototype.close=function(){var e,t,n,r,i;this.removeAllPolygonsAndBindings(),this.area.off("sync",this.render),this.area.off("addedPolygon",this.addPolygon),r=this.polysObserved,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.off("change",this.render));return i},t.prototype.removeAllPolygonsAndBindings=function(){var e,t;t=[];while(e=this.mapPolygons.shift())t.push(this.removeMapPolygonAndBindings(e));return t},t.prototype.removeMapPolygonAndBindings=function(e){return e.off("click",this.triggerPolyClicked),Pica.config.map.removeLayer(e)},t.prototype.triggerPolyClick=function(e,t,n){return this.trigger("polygonClick",[e,t,n])},t}(Pica.Events);var __bind=function(e,t){return function(){return e.apply(t,arguments)}};Pica.Views.ShowLayersView=function(){function e(e){this.removeTileLayers=__bind(this.removeTileLayers,this),this.render=__bind(this.render,this),this.app=e.app,this.app.on("sync",this.render),this.tileLayers=[],this.render()}return e.prototype.render=function(){var e,t,n,r,i,s;this.removeTileLayers(),i=this.app.layers,s=[];for(n=0,r=i.length;n<r;n++)e=i[n],t=new L.TileLayer(e.tile_url),this.tileLayers.push(t),s.push(t.addTo(this.app.config.map));return s},e.prototype.removeTileLayers=function(){var e,t,n,r,i;r=this.tileLayers,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(this.app.map.removeLayer(e));return i},e.prototype.close=function(){return this.removeTileLayers(),this.app.off("sync",this.render)},e}(),Pica.Views.UploadFileView=function(){function e(e){e.callbacks!=null&&(this.successCallback=e.callbacks.success,this.errorCallback=e.callbacks.error),this.area=e.area,this.el=document.createElement("div"),this.render()}return e.prototype.render=function(){var e;return e=document.createElement("iframe"),e.src=""+Pica.config.magpieUrl+"/workspaces/"+this.area.get("workspace_id")+"/areas_of_interest/"+this.area.get("id")+"/polygons/upload_file_url",this.el.appendChild(e)},e.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:circle-created")},e}();