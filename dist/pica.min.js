/*! pica - v0.1.0 - 2012-11-26
* https://github.com/unepwcmc/pica.js
* Copyright (c) 2012 UNEP-WCMC; */
window.Pica={},Pica.Models={},Pica.Views={},Pica.Application=function(){function e(e){this.config=e,Pica.config=this.config,$.support.cors=!0,$.ajaxSetup({headers:{"X-Magpie-AppId":Pica.config.appId}})}return e.prototype.newWorkspace=function(){return this.currentWorkspace=new Pica.Models.Workspace},e}(),Pica.Events=function(){function e(){}return e.prototype.on=function(e,t){var n;return this.events||(this.events={}),(n=this.events)[e]||(n[e]=[]),this.events[e].push(t)},e.prototype.off=function(e,t){var n,r,i,s,o,u;if(this.events==null)return;if(e==null)return this.events=[];if(this.events[e]!=null){if(t!=null){o=this.events[e],u=[];for(n=i=0,s=o.length;i<s;n=++i)r=o[n],n===t?u.push(delete this.events[e][r]):u.push(void 0);return u}return delete this.events[e]}},e.prototype.trigger=function(e,t){var n,r,i,s,o;if(this.events!=null&&this.events[e]!=null){s=this.events[e],o=[];for(r=0,i=s.length;r<i;r++)n=s[r],o.push(n.apply(this,[].concat(t)));return o}},e}();var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Model=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url=function(){},t.prototype.get=function(e){var t;return(t=this.attributes)==null&&(this.attributes={}),this.attributes[e]},t.prototype.set=function(e,t){var n;return(n=this.attributes)==null&&(this.attributes={}),this.attributes[e]=t},t.prototype.sync=function(e){var t,n,r=this;return e==null&&(e={}),t=e.success||function(){},e.success=function(e,n,i){if(e.id!=null)return r.parse(e),r.trigger("sync",r),t(r,n,i)},n=this.attributes,e.type==="post"&&(n=JSON.stringify(n)),$.ajax($.extend(e,{dataType:"json",contentType:"application/json",data:n}))},t.prototype.parse=function(e){var t,n,r;r=[];for(t in e)n=e[t],r.push(this.set(t,n));return r},t.prototype.save=function(e){return e==null&&(e={}),e.url=this.url().create!=null?this.url().create:this.url(),e.type="post",this.sync(e)},t.prototype.fetch=function(e){return e==null&&(e={}),e.url=this.url().read!=null?this.url().read:this.url(),this.sync(e)},t}(Pica.Events);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Workspace=function(e){function t(){this.save=__bind(this.save,this),this.attributes={},this.areas=[],this.currentArea=new Pica.Models.Area,this.addArea(this.currentArea)}return __extends(t,e),t.prototype.url=function(){return""+Pica.config.magpieUrl+"/workspaces"},t.prototype.addArea=function(e){return e.on("requestWorkspaceId",this.save),this.areas.push(e)},t.prototype.save=function(e){return t.__super__.save.call(this,e)},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Area=function(e){function t(e){this.save=__bind(this.save,this),this.fetch=__bind(this.fetch,this),this.polygons=[],this.set("name","My Lovely Area")}return __extends(t,e),t.prototype.setName=function(e){return this.set("name",e)},t.prototype.addPolygon=function(e){return e.on("requestAreaId",this.save),e.on("sync",this.fetch),this.polygons.push(e)},t.prototype.drawNewPolygonView=function(e){return this.currentPolygon=new Pica.Models.Polygon,this.addPolygon(this.currentPolygon),new Pica.Views.NewPolygonView({finishedCallback:e,polygon:this.currentPolygon})},t.prototype.newShowAreaPolygonsView=function(){return new Pica.Views.ShowAreaPolygonsView({area:this})},t.prototype.url=function(){return{create:""+Pica.config.magpieUrl+"/workspaces/"+this.get("workspace_id")+"/areas_of_interest/",read:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("id")}},t.prototype.fetch=function(){return t.__super__.fetch.apply(this,arguments)},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("workspace_id")!=null?t.__super__.save.call(this,e):this.trigger("requestWorkspaceId",{success:function(t,r,i){return n.set("workspace_id",t.get("id")),n.get("workspace_id")?n.save(e):e.error(n,{error:"Could not save workspace, so cannot save area"},i)}})},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Polygon=function(e){function t(){this.save=__bind(this.save,this),this.attributes={}}return __extends(t,e),t.prototype.isComplete=function(){return this.get("geometry")!=null},t.prototype.setGeomFromPoints=function(e){var t;return e=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push([t.lng,t.lat]);return i}(),e.push(e[0]),this.set("geometry",[[e]])},t.prototype.geomAsLatLngArray=function(){var e,t,n,r,i;e=[];if(this.isComplete()){i=this.get("geometry")[0][0];for(n=0,r=i.length;n<r;n++)t=i[n],e.push(new L.LatLng(t[1],t[0]))}return e},t.prototype.url=function(){return{read:""+Pica.config.magpieUrl+"/polygons/"+this.get("id"),create:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("area_id")+"/polygons"}},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("area_id")!=null?t.__super__.save.call(this,e):this.trigger("requestAreaId",{success:function(t,r,i){n.set("area_id",t.get("id"));if(n.get("area_id"))return n.save(e);if(e.error!=null)return e.error(n,{error:"Could not save area, so cannot save polygon"},i)},error:function(e){return console.log("Unable to save polygon:"),console.log(e)}})},t}(Pica.Model),Pica.Views.NewPolygonView=function(){function e(e){var t=this;this.finishedCallback=e.finishedCallback,this.polygon=e.polygon,this.polygonDraw=new L.Polygon.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:poly-created",function(e){var n;return n=e.poly,t.createPolygon(n)})}return e.prototype.createPolygon=function(e){var t=this;return this.polygon.setGeomFromPoints(e.getLatLngs()),this.polygon.save({success:function(){t.close();if(typeof finishedCallback!="undefined"&&finishedCallback!==null)return t.finishedCallback()}})},e.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:poly-created")},e}();var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Views.ShowAreaPolygonsView=function(e){function t(e){this.triggerPolyClick=__bind(this.triggerPolyClick,this),this.render=__bind(this.render,this),this.area=e.area,this.mapPolygons=[],this.area.on("sync",this.render),this.render()}return __extends(t,e),t.prototype.render=function(){var e,t,n,r,i,s,o=this;this.removeAllPolygonsAndBindings(),i=this.area.polygons,s=[];for(n=0,r=i.length;n<r;n++){t=i[n];if(!t.isComplete())continue;e=(new L.Polygon(t.geomAsLatLngArray())).addTo(Pica.config.map),e.on("click",function(){var e;return e=t,function(t){return o.triggerPolyClick(e,t)}}()),t.on("delete",function(){return removeMapPolygonAndBindings(e)}),s.push(this.mapPolygons.push(e))}return s},t.prototype.close=function(){return this.removeAllPolygonsAndBindings()},t.prototype.removeAllPolygonsAndBindings=function(){var e,t;t=[];while(e=this.mapPolygons.shift())t.push(this.removeMapPolygonAndBindings(e));return t},t.prototype.removeMapPolygonAndBindings=function(e){return e.off("click",this.triggerPolyClicked),Pica.config.map.removeLayer(e)},t.prototype.triggerPolyClick=function(e,t){return this.trigger("polygonClick",[e,t])},t}(Pica.Events);