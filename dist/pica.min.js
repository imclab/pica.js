/*! pica - v0.1.0 - 2012-11-22
* https://github.com/unepwcmc/pica.js
* Copyright (c) 2012 UNEP-WCMC; */
window.Pica={},Pica.Models={},Pica.Views={},Pica.Application=function(){function e(e){this.config=e,Pica.config=this.config,$.support.cors=!0,$.ajaxSetup({headers:{"X-Magpie-AppId":Pica.config.appId}})}return e.prototype.newWorkspace=function(){return this.currentWorkspace=new Pica.Models.Workspace},e}(),Pica.Events=function(){function e(){}return e.prototype.on=function(e,t){var n;return this.events||(this.events={}),(n=this.events)[e]||(n[e]=[]),this.events[e].push(t)},e.prototype.off=function(e,t){var n,r,i,s,o,u;if(this.events==null)return;if(e==null)return this.events=[];if(this.events[e]!=null){if(t!=null){o=this.events[e],u=[];for(n=i=0,s=o.length;i<s;n=++i)r=o[n],n===t?u.push(delete this.events[e][r]):u.push(void 0);return u}return delete this.events[e]}},e.prototype.trigger=function(e,t){var n,r;if(this.events!=null&&this.events[e]!=null){r=[];while(n=this.events[e].shift())r.push(n.apply(this,[].concat(t)));return r}},e}();var __hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Model=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.url=function(){},t.prototype.get=function(e){return this.attributes[e]},t.prototype.set=function(e,t){return this.attributes[e]=t},t.prototype.sync=function(e){var t,n=this;return e==null&&(e={}),t=e.success||function(){},e.success=function(e,r,i){var s,o;if(e.id!=null){for(s in e)o=e[s],n.set(s,o);return t(n,r,i)}},$.ajax($.extend(e,{dataType:"json",data:this.attributes}))},t.prototype.save=function(e){return e==null&&(e={}),e.url=this.url().create!=null?this.url().create:this.url(),e.type="post",this.sync(e)},t.prototype.fetch=function(e){return e==null&&(e={}),e.url=this.url().read!=null?this.url().read:this.url(),this.sync(e)},t}(Pica.Events);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Workspace=function(e){function t(){this.save=__bind(this.save,this),this.attributes={},this.areas=[],this.currentArea=new Pica.Models.Area,this.addArea(this.currentArea)}return __extends(t,e),t.prototype.url=function(){return""+Pica.config.magpieUrl+"/workspaces"},t.prototype.addArea=function(e){return e.on("requestWorkspaceId",this.save),this.areas.push(e)},t.prototype.save=function(e){return t.__super__.save.call(this,e)},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Area=function(e){function t(e){this.save=__bind(this.save,this),this.attributes={},this.polygons=[],this.set("name","My Lovely Area")}return __extends(t,e),t.prototype.setName=function(e){return this.set("name",e)},t.prototype.addPolygon=function(e){return e.on("requestAreaId",this.save),this.polygons.push(e)},t.prototype.drawNewPolygonView=function(e){return this.currentPolygon=new Pica.Models.Polygon,this.addPolygon(this.currentPolygon),new Pica.Views.NewPolygonView({finishedCallback:e,polygon:this.currentPolygon})},t.prototype.stats=function(){return this.get("results")!=null?(this.trigger("area:statsCalculated"),this.get("results")):this.fetchStats(this.stats)},t.prototype.fetchStats=function(e){return this.fetch({success:e})},t.prototype.url=function(){return{create:""+Pica.config.magpieUrl+"/workspaces/"+this.get("workspace_id")+"/areas_of_interest/",read:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("id")}},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("workspace_id")!=null?t.__super__.save.call(this,e):this.trigger("requestWorkspaceId",{success:function(t,r,i){return n.set("workspace_id",t.get("id")),n.get("workspace_id")?n.save(e):e.error(n,{error:"Could not save workspace, so cannot save area"},i)}})},t}(Pica.Model);var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Pica.Models.Polygon=function(e){function t(){this.save=__bind(this.save,this),this.attributes={}}return __extends(t,e),t.prototype.setGeomFromPoints=function(e){var t;return e=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push([t.lng,t.lat]);return i}(),e.push(e[0]),this.set("geometry",[[e]])},t.prototype.url=function(){return{read:""+Pica.config.magpieUrl+"/polygons",create:""+Pica.config.magpieUrl+"/areas_of_interest/"+this.get("area_id")+"/polygons"}},t.prototype.save=function(e){var n=this;return e||(e={}),this.get("area_id")!=null?t.__super__.save.call(this,e):this.trigger("requestAreaId",{success:function(t,r,i){n.set("area_id",t.get("id"));if(n.get("area_id"))return n.save(e);if(e.error!=null)return e.error(n,{error:"Could not save area, so cannot save polygon"},i)},error:function(){return console.log("Unable to save polygon:"),console.log(error)}})},t}(Pica.Model),Pica.Views.NewPolygonView=function(){function e(e){var t=this;this.finishedCallback=e.finishedCallback,this.polygon=e.polygon,this.polygonDraw=new L.Polygon.Draw(Pica.config.map,{}),this.polygonDraw.enable(),Pica.config.map.on("draw:poly-created",function(e){var n;return n=e.poly,t.createPolygon(n)})}return e.prototype.createPolygon=function(e){var t=this;return this.polygon.setGeomFromPoints(e.getLatLngs()),this.polygon.save({success:function(){return t.close(),t.finishedCallback()}})},e.prototype.close=function(){return this.polygonDraw.disable(),Pica.config.map.off("draw:poly-created")},e}();