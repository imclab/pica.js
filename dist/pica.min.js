/**
 * almond 0.2.5 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

(function(t,e){"function"==typeof define&&define.amd?define(e):t.pica=e()})(this,function(){var t,e,r;return function(n){function o(t,e){return _.call(t,e)}function s(t,e){var r,n,o,s,i,a,l,p,u,c,h=e&&e.split("/"),f=m.map,y=f&&f["*"]||{};if(t&&"."===t.charAt(0))if(e){for(h=h.slice(0,h.length-1),t=h.concat(t.split("/")),p=0;t.length>p;p+=1)if(c=t[p],"."===c)t.splice(p,1),p-=1;else if(".."===c){if(1===p&&(".."===t[2]||".."===t[0]))break;p>0&&(t.splice(p-1,2),p-=2)}t=t.join("/")}else 0===t.indexOf("./")&&(t=t.substring(2));if((h||y)&&f){for(r=t.split("/"),p=r.length;p>0;p-=1){if(n=r.slice(0,p).join("/"),h)for(u=h.length;u>0;u-=1)if(o=f[h.slice(0,u).join("/")],o&&(o=o[n])){s=o,i=p;break}if(s)break;!a&&y&&y[n]&&(a=y[n],l=p)}!s&&a&&(s=a,i=l),s&&(r.splice(0,i,s),t=r.join("/"))}return t}function i(t,e){return function(){return f.apply(n,b.call(arguments,0).concat([t,e]))}}function a(t){return function(e){return s(e,t)}}function l(t){return function(e){d[t]=e}}function p(t){if(o(v,t)){var e=v[t];delete v[t],w[t]=!0,h.apply(n,e)}if(!o(d,t)&&!o(w,t))throw Error("No "+t);return d[t]}function u(t){var e,r=t?t.indexOf("!"):-1;return r>-1&&(e=t.substring(0,r),t=t.substring(r+1,t.length)),[e,t]}function c(t){return function(){return m&&m.config&&m.config[t]||{}}}var h,f,y,g,d={},v={},m={},w={},_=Object.prototype.hasOwnProperty,b=[].slice;y=function(t,e){var r,n=u(t),o=n[0];return t=n[1],o&&(o=s(o,e),r=p(o)),o?t=r&&r.normalize?r.normalize(t,a(e)):s(t,e):(t=s(t,e),n=u(t),o=n[0],t=n[1],o&&(r=p(o))),{f:o?o+"!"+t:t,n:t,pr:o,p:r}},g={require:function(t){return i(t)},exports:function(t){var e=d[t];return e!==void 0?e:d[t]={}},module:function(t){return{id:t,uri:"",exports:d[t],config:c(t)}}},h=function(t,e,r,s){var a,u,c,h,f,m,_=[];if(s=s||t,"function"==typeof r){for(e=!e.length&&r.length?["require","exports","module"]:e,f=0;e.length>f;f+=1)if(h=y(e[f],s),u=h.f,"require"===u)_[f]=g.require(t);else if("exports"===u)_[f]=g.exports(t),m=!0;else if("module"===u)a=_[f]=g.module(t);else if(o(d,u)||o(v,u)||o(w,u))_[f]=p(u);else{if(!h.p)throw Error(t+" missing "+u);h.p.load(h.n,i(s,!0),l(u),{}),_[f]=d[u]}c=r.apply(d[t],_),t&&(a&&a.exports!==n&&a.exports!==d[t]?d[t]=a.exports:c===n&&m||(d[t]=c))}else t&&(d[t]=r)},t=e=f=function(t,e,r,o,s){return"string"==typeof t?g[t]?g[t](e):p(y(t,e).f):(t.splice||(m=t,e.splice?(t=e,e=r,r=null):t=n),e=e||function(){},"function"==typeof r&&(r=o,o=s),o?h(n,t,e,r):setTimeout(function(){h(n,t,e,r)},4),f)},f.config=function(t){return m=t,m.deps&&f(m.deps,m.callback),f},r=function(t,e,r){e.splice||(r=e,e=[]),o(d,t)||o(v,t)||(v[t]=[t,e,r])},r.amd={jQuery:!0}}(),r("almond",function(){}),function(){r("lib/pica_event",[],function(){var t;return t=function(){function t(){}return t.prototype.on=function(t,e){var r;return this.events||(this.events={}),(r=this.events)[t]||(r[t]=[]),this.events[t].push(e)},t.prototype.off=function(t,e){var r,n,o,s,i,a;if(null!=this.events){if(null==t)return this.events=[];if(null!=this.events[t]){if(null!=e){for(i=this.events[t],a=[],n=o=0,s=i.length;s>o;n=++o)r=i[n],r===e?(this.events[t].splice(n,1),a.push(n-=1)):a.push(void 0);return a}return delete this.events[t]}}},t.prototype.trigger=function(t,e){var r,n,o,s,i;if(null!=this.events&&null!=this.events[t]){for(s=this.events[t],i=[],n=0,o=s.length;o>n;n++)r=s[n],i.push(r.apply(this,[].concat(e)));return i}},t}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("lib/pica_model",["lib/pica_event"],function(e){var r,o;return r=function(e){function r(){return this.destroy=t(this.destroy,this),this.fetch=t(this.fetch,this),this.save=t(this.save,this),o=r.__super__.constructor.apply(this,arguments)}return n(r,e),r.prototype.throwIfNoApp=function(){if(null==this.app)throw Error("Cannot create a PicaModel without specifying a PicaApplication")},r.prototype.url=function(){},r.prototype.get=function(t){var e;return null==(e=this.attributes)&&(this.attributes={}),this.attributes[t]},r.prototype.set=function(t,e){var r;return null==(r=this.attributes)&&(this.attributes={}),this.attributes[t]=e,this.trigger("change")},r.prototype.sync=function(t){var e,r,n,o=this;return null==t&&(t={}),n=t.success||function(){},t.success=function(t,e,r){return null!=t.id&&(o.parse(t),o.trigger("sync",o)),o.app.notifySyncFinished(),n(o,e,r)},r=t.error||function(){},t.error=function(t,e,n){return o.app.notifySyncFinished(),r(o,e,n)},("post"===t.type||"put"===t.type)&&(e=this.attributes,"post"===t.type&&(e=JSON.stringify(e))),"delete"===t.type&&(e=null),this.app.notifySyncStarted(),$.ajax($.extend(t,{contentType:"application/json",dataType:"json",data:e}))},r.prototype.parse=function(t){var e,r,n;n=[];for(e in t)r=t[e],n.push(this.set(e,r));return n},r.prototype.save=function(t){var e,r=this;return null==t&&(t={}),null!=this.get("id")?(t.url=null!=this.url().read?this.url().read:this.url(),t.type="put"):(t.url=null!=this.url().create?this.url().create:this.url(),t.type="post"),e=this.sync(t),e.done(function(){return console.log("saving "+r.constructor.name+" "+r.get("id"))}),e},r.prototype.fetch=function(t){return null==t&&(t={}),t.url=null!=this.url().read?this.url().read:this.url(),console.log("fetching "+this.constructor.name+" "+this.get("id")),this.sync(t)},r.prototype.destroy=function(t){var e,r=this;return null==t&&(t={}),t.url=null!=this.url().read?this.url().read:this.url(),t.type="delete",e=t.success,t.success=function(){return r.trigger("delete"),console.log("deleted "+r.constructor.name+" "+r.get("id")),e&&e(),r.off()},this.sync(t)},r}(e)})}.call(this),function(){r("views/new_polygon_view",[],function(){var t;return t=function(){function t(t){var e=this;this.options=t,null!=this.options.callbacks&&(this.successCallback=this.options.callbacks.success,this.errorCallback=this.options.callbacks.error),this.polygon=this.options.polygon,this.polygonDraw=new L.Polygon.Draw(this.options.map,{}),this.polygonDraw.enable(),this.options.map.on("draw:poly-created",function(t){var r;return r=t.poly,e.createPolygon(r)})}return t.prototype.createPolygon=function(t){var e=this;return this.polygon.setGeomFromPoints(t.getLatLngs()),this.polygon.save({success:function(){return e.close(),null!=e.successCallback?e.successCallback():void 0},error:function(){return e.close(),null!=e.errorCallback?e.errorCallback.apply(e,arguments):void 0}})},t.prototype.close=function(){return this.polygonDraw.disable(),this.options.map.off("draw:poly-created")},t}()})}.call(this),function(){r("views/new_circle_view",[],function(){var t;return t=function(){function t(t){var e=this;this.options=t,null!=this.options.callbacks&&(this.successCallback=this.options.callbacks.success,this.errorCallback=this.options.callbacks.error),this.polygon=this.options.polygon,this.polygon.set("geometry",{type:"Circle"}),this.polygonDraw=new L.Circle.Draw(this.options.map,{}),this.polygonDraw.enable(),this.options.map.on("draw:circle-created",function(t){return e.createPolygon(t.circ)})}return t.prototype.createPolygon=function(t){var e=this;return this.polygon.setGeomFromCircle(t.getLatLng(),t.getRadius()),this.polygon.save({success:function(){return e.close(),null!=e.successCallback?e.successCallback():void 0},error:function(){return e.close(),null!=e.errorCallback?e.errorCallback.apply(e,arguments):void 0}})},t.prototype.close=function(){return this.polygonDraw.disable(),this.options.map.off("draw:circle-created")},t}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("views/upload_file_view",["lib/pica_event"],function(e){var r;return r=function(e){function r(e){this.options=e,this.onUploadComplete=t(this.onUploadComplete,this),this.render=t(this.render,this),null!=e.callbacks&&(this.successCallback=this.options.callbacks.success,this.errorCallback=this.options.callbacks.error),this.area=this.options.area,this.el=document.createElement("div"),this.area.getAreaId({success:this.render})}return n(r,e),r.prototype.render=function(){var t;return t=document.createElement("iframe"),t.src=""+this.options.magpieUrl+"/areas_of_interest/"+this.area.get("id")+"/polygons/new_upload_form/",t.className="pica-upload-form",this.el.appendChild(t),window.addEventListener("message",this.onUploadComplete,!1)},r.prototype.onUploadComplete=function(t){return t.origin===this.options.magpieUrl&&null!=t.data.polygonImportStatus?("Successful import"===t.data.polygonImportStatus&&null!=this.successCallback?this.successCallback(t.data.polygonImportStatus,t.data.importMessages):null!=this.errorCallback&&this.errorCallback(t.data.polygonImportStatus,t.data.importMessages),this.close()):void 0},r.prototype.close=function(){return window.removeEventListener("message",this.onUploadComplete),$(this.el).remove()},r}(e)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("views/show_area_polygons_view",["lib/pica_event"],function(e){var r;return r=function(e){function r(e){this.options=e,this.triggerPolyClick=t(this.triggerPolyClick,this),this.addPolygon=t(this.addPolygon,this),this.render=t(this.render,this),this.area=this.options.area,this.polysObserved=[],this.mapPolygons=[],this.area.on("sync",this.render),this.area.on("addedPolygon",this.addPolygon),this.render()}return n(r,e),r.prototype.render=function(){var t,e,r,n,o,s,i,a=this;for(this.removeAllPolygonsAndBindings(),s=this.area.polygons,i=[],n=0,o=s.length;o>n;n++)r=s[n],r.isComplete()&&(e=function(t,e){var r;return r=function(e){return t.apply(this,e)},r.prototype=t.prototype,new r(e)},t=e(L[r.get("geometry").type],r.asLeafletArguments()).addTo(this.options.map),r.on("delete",function(){var e;return e=t,function(){return a.removeMapPolygonAndBindings(e)}}()),t.on("click",function(){var e,n;return n=r,e=t,function(t){return a.triggerPolyClick(n,t,e)}}()),i.push(this.mapPolygons.push(t)));return i},r.prototype.addPolygon=function(t){return t.on("change",this.render),this.polysObserved.push(t)},r.prototype.close=function(){var t,e,r,n,o;for(this.removeAllPolygonsAndBindings(),this.area.off("sync",this.render),this.area.off("addedPolygon",this.addPolygon),n=this.polysObserved,o=[],e=0,r=n.length;r>e;e++)t=n[e],o.push(t.off("change",this.render));return o},r.prototype.removeAllPolygonsAndBindings=function(){var t,e;for(e=[];t=this.mapPolygons.shift();)e.push(this.removeMapPolygonAndBindings(t));return e},r.prototype.removeMapPolygonAndBindings=function(t){return t.off("click",this.triggerPolyClicked),this.options.map.removeLayer(t)},r.prototype.triggerPolyClick=function(t,e,r){return this.trigger("polygonClick",[t,e,r])},r}(e)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("models/polygon",["lib/pica_model"],function(e){var r;return r=function(e){function r(e,r){var n;this.app=e,null==r&&(r={}),this.save=t(this.save,this),this.throwIfNoApp(),this.attributes=null!=r.attributes?r.attributes:{},(n=this.attributes).geometry||(n.geometry={type:"Polygon"})}return n(r,e),r.prototype.isComplete=function(){return null!=this.get("geometry").coordinates},r.prototype.setGeomFromPoints=function(t){var e;return t=function(){var r,n,o;for(o=[],r=0,n=t.length;n>r;r++)e=t[r],o.push([e.lng,e.lat]);return o}(),t.push(t[0]),this.set("geometry",{type:"Polygon",coordinates:[t]})},r.prototype.setGeomFromCircle=function(t,e){return this.set("geometry",{type:"Circle",coordinates:[t.lng,t.lat],radius:e})},r.prototype.asLeafletArguments=function(){var t,e,r,n,o,s;if(t=[],"Polygon"===this.get("geometry").type){if(e=[],this.isComplete())for(s=this.get("geometry").coordinates[0],n=0,o=s.length;o>n;n++)r=s[n],e.push(new L.LatLng(r[1],r[0]));t.push(e)}else this.isComplete()?(r=this.get("geometry").coordinates,t=[new L.LatLng(r[1],r[0]),this.get("geometry").radius]):t=[[],0];return t},r.prototype.url=function(){var t;return t=this.app.config.magpieUrl,{read:""+t+"/polygons/"+this.get("id")+".json",create:""+t+"/areas_of_interest/"+this.get("area_id")+"/polygons.json"}},r.prototype.save=function(t){var e=this;return t||(t={}),null!=this.get("area_id")?r.__super__.save.call(this,t):this.trigger("requestAreaId",{success:function(r,n,o){return e.set("area_id",r.get("id")),e.get("area_id")?e.save(t):null!=t.error?t.error(e,{error:"Unable to get area id, so cannot save polygon"},o):void 0},error:function(e,r,n){return console.log("Unable to save polygon:"),console.log(arguments),console.log(e.status),console.log(e.statusText),console.log(e.responseText),null!=t.error?t.error(e,r,{error:"Unable to obtain areaId, cannot save polygon",parentError:n}):void 0}})},r}(e)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("models/area",["lib/pica_model","views/new_polygon_view","views/new_circle_view","views/upload_file_view","views/show_area_polygons_view","models/polygon"],function(e,r,o,s,i,a){var l;return l=function(e){function l(e){this.app=e,this.save=t(this.save,this),this.getAreaId=t(this.getAreaId,this),this.throwIfNoApp(),this.polygons=[],this.set("name","My Lovely Area")}return n(l,e),l.prototype.setName=function(t){return this.set("name",t)},l.prototype.addPolygon=function(t){var e=this;return t.on("requestAreaId",this.getAreaId),t.on("sync",function(){return e.fetch()}),t.on("delete",function(){return e.fetch()}),this.polygons.push(t),this.trigger("addedPolygon",t)},l.prototype.getAreaId=function(t){return null!=this.get("id")?t.success(this):this.save(t)},l.prototype.drawNewPolygonView=function(t){return this.createPolygon(),new r({callbacks:t,polygon:this.currentPolygon,map:this.app.config.map})},l.prototype.drawNewCircleView=function(t){return this.createPolygon(),new o({callbacks:t,polygon:this.currentPolygon,map:this.app.config.map})},l.prototype.createPolygon=function(){return this.currentPolygon=new a(this.app),this.addPolygon(this.currentPolygon)},l.prototype.newUploadFileView=function(t){return new s({callbacks:t,area:this,magpieUrl:this.app.config.magpieUrl})},l.prototype.newShowAreaPolygonsView=function(){return new i({area:this,map:this.app.config.map})},l.prototype.url=function(){var t;return t=this.app.config.magpieUrl,{create:""+t+"/workspaces/"+this.get("workspace_id")+"/areas_of_interest.json",read:""+t+"/areas_of_interest/"+this.get("id")+".json"}},l.prototype.parse=function(t){var e,r,n,o,s,i,p,u,c,h;if(null!=t.polygons){for(this.polygons=[],c=t.polygons,s=0,p=c.length;p>s;s++)n=c[s],r=new a(this.app,{attributes:n}),this.addPolygon(r);delete t.polygons}else{for(o=[],h=this.polygons,e=i=0,u=h.length;u>i;e=++i)r=h[e],null==r.get("id")&&o.push(r);this.polygons=o}return l.__super__.parse.apply(this,arguments)},l.prototype.save=function(t){var e=this;return t||(t={}),null!=this.get("workspace_id")?l.__super__.save.call(this,t):this.trigger("requestWorkspaceId",{success:function(r,n,o){return e.set("workspace_id",r.get("id")),e.get("workspace_id")?e.save(t):t.error(e,{error:"Could not save workspace, so cannot save area"},o)},error:function(e,r,n){return console.log("Unable to save area:"),console.log(arguments),console.log(e.status),console.log(e.statusText),console.log(e.responseText),null!=t.error?t.error(e,r,{error:"Unable to obtain workspaceId, cannot save area",parentError:n}):void 0}})},l}(e)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("models/workspace",["lib/pica_model","models/area"],function(e,r){var o;return o=function(e){function o(e){this.app=e,this.save=t(this.save,this),this.throwIfNoApp(),this.attributes={},this.areas=[],this.currentArea=new r(this.app),this.addArea(this.currentArea)}return n(o,e),o.prototype.url=function(){return""+this.app.config.magpieUrl+"/workspaces.json"},o.prototype.addArea=function(t){var e=this;return t.on("requestWorkspaceId",function(t){return null!=e.get("id")?t.success(e):e.save(t)}),this.areas.push(t)},o.prototype.removeArea=function(t){var e,r;return r=this.areas.indexOf(t),e=this.areas.splice(r,1)[0],null!=e.get("id")?e.destroy():void 0},o.prototype.setCurrentArea=function(t){var e,r,n,o,s;for(o=this.areas,s=[],r=0,n=o.length;n>r;r++)e=o[r],e===t?s.push(this.currentArea=e):s.push(void 0);return s},o.prototype.setCurrentAreaById=function(t){var e,r,n,o,s;for(o=this.areas,s=[],r=0,n=o.length;n>r;r++)e=o[r],e.get("id")===t?s.push(this.currentArea=e):s.push(void 0);return s},o.prototype.save=function(t){return o.__super__.save.call(this,t)},o}(e)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};r("views/show_layers_view",[],function(){var e;return e=function(){function e(e){this.removeTileLayers=t(this.removeTileLayers,this),this.render=t(this.render,this),this.app=e.app,this.app.on("sync",this.render),this.tileLayers={},this.layerControl=!1}return e.prototype.render=function(){var t,e,r,n,o;for(this.removeTileLayers(),this.removeLayerControl(),o=this.app.layers,r=0,n=o.length;n>r;r++)t=o[r],e=L.tileLayer(t.tile_url),this.tileLayers[t.display_name]=e,this.app.config.delegateLayerControl||e.addTo(this.app.config.map);return this.app.config.delegateLayerControl?this.layerControl=this.renderLayerControl(this.app.config.map):void 0},e.prototype.renderLayerControl=function(t){var e,r;return e=this.app.config.extraOverlays||{},r=$.extend(this.tileLayers,e),this.showFirstOverlay(r,t),L.control.layers({},r).addTo(t)},e.prototype.showFirstOverlay=function(t,e){var r,n;for(n in t)return r=t[n],r.addTo(e),void 0},e.prototype.removeTileLayers=function(){var t,e,r,n;r=this.tileLayers,n=[];for(t in r)e=r[t],n.push(this.app.map.removeLayer(e));return n},e.prototype.removeLayerControl=function(){return this.layerControl?this.layerControl.removeFrom(this.app.map):void 0},e.prototype.close=function(){return this.removeTileLayers(),this.removeLayerControl(),this.app.off("sync",this.render)},e}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,r){function n(){this.constructor=t}for(var o in r)e.call(r,o)&&(t[o]=r[o]);return n.prototype=r.prototype,t.prototype=new n,t.__super__=r.prototype,t};r("pica_application",["lib/pica_event","lib/pica_model","models/workspace","views/show_layers_view"],function(e,r,o,s){var i;return i=function(e){function r(e){this.config=e,this.parse=t(this.parse,this),$.support.cors=!0,$.ajaxSetup({headers:{"X-Magpie-ProjectId":this.config.projectId}}),this.layers=[],this.fetch(),this.config.delegateLayerControl&&this.showTileLayers()}return n(r,e),r.prototype.newWorkspace=function(){return this.currentWorkspace=new o(this)},r.prototype.showTileLayers=function(){return new s({app:this})},r.prototype.fetch=function(){return $.ajax({url:""+this.config.magpieUrl+"/projects/"+this.config.projectId+".json",type:"get",success:this.parse})},r.prototype.parse=function(t){var e,r;for(e in t)r=t[e],this[e]=r;return this.trigger("sync")},r.prototype.notifySyncStarted=function(){return this.syncsInProgress||(this.syncsInProgress=0),this.syncsInProgress=this.syncsInProgress+1,1===this.syncsInProgress?this.trigger("syncStarted"):void 0},r.prototype.notifySyncFinished=function(){return this.syncsInProgress||(this.syncsInProgress=0),this.syncsInProgress=this.syncsInProgress-1,0===this.syncsInProgress?this.trigger("syncFinished"):void 0},r}(e)})}.call(this),function(){r("pica",["lib/pica_event","models/area","pica_application"],function(t,e,r){var n;return n={},n.PicaModelsArea=e,n.PicaApplication=r,n})}.call(this),e("pica")});