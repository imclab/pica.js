<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pica.js Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.css" />
  <link rel="stylesheet" href="css/leaflet.draw.css" />
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.ie.css" />
  <![endif]-->
  <link rel="stylesheet" href="css/app.css" />

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.js"></script>
  <script src="js/leaflet.draw.js"></script>

  <script src="js/pica.js"></script>

  <script>
    $(document).ready(function() {
      var AreaView, map, pica, tileLayer, tileLayerUrl;
      /* == AreaView.js == 
      Render an area's stats as they are calculated */
      var AreaView = (function() {

        AreaView.prototype.render = function(area) {
          var stat, stats, _i, _len;
          stats = area.get('results');
          if (typeof(stats) !== 'undefined') {
            $(this.targetElement).html('');
            for (_i = 0, _len = stats.length; _i < _len; _i++) {
              stat = stats[_i];
              $(this.targetElement).append(stat.display_name + ": " + stat.value + stat.unit + "<br/>");
            }
          }
        };

        function AreaView(targetElement) {
          var _this = this;
          this.targetElement = targetElement;
          // Listen for the 'sync' event on the area, which is triggered when stats are updated
          pica.currentWorkspace.currentArea.on("sync", function(area) {
            _this.render(area);
          });
        };

        return AreaView;
      })();

      map = L.map('map',{
        center: [24.5,54],
        minZoom: 7,
        zoom: 9
      })
      tileLayerUrl = 'http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}.png';
      tileLayer = new L.TileLayer(tileLayerUrl, {
        maxZoom: 18
      }).addTo(map);
      pica = new Pica.Application({
        magpieUrl: "http://magpie.unepwcmc-005.vm.brightbox.net",
        appId: 3,
        map: map
      });
      pica.newWorkspace();

      // Show drawn polygons on the map
      var showAreaPolygonsView = pica.currentWorkspace.currentArea.newShowAreaPolygonsView();
      showAreaPolygonsView.on("polygonClick", function(polygon, event)
      {alert("You clicked polygon "+polygon.get('id'))})
      new AreaView("#area-stats");

      // Draw a new polygon view when user clicks add button
      $('#add-polygon-btn').click(function(){
        pica.currentWorkspace.currentArea.drawNewPolygonView();
      });

    });
  </script>

</head>
<body>
  <div class="container-fluid">
    <div id="header">
      <h1>Pica.js demo</h1>
    </div>
    <div class="row-fluid">
      <div class="span9">
        <!--Body content-->
        <div id="map"></div>
      </div>
      <div class="span3 well">
        <!--Sidebar content-->
        <div id="side-panel">
          <input id="add-polygon-btn" class="btn" type="submit" value="Add polygon"/>
          <div id="area-stats"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
  </script>
</body>
</html>
