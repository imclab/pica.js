<!DOCTYPE html>

<html>
<head>
  <title>pica.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pica.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <ul>
<li>pica.js</li>
<li><a href="https://github.com/unepwcmc/pica.js">https://github.com/unepwcmc/pica.js</a>
*</li>
<li>Copyright (c) 2012 UNEP-WCMC</li>
</ul>
<h2>Dependencies:</h2>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <ul>
<li><a href="http://jquery.com/">http://jquery.com/</a></li>
<li><a href="http://leafletjs.com/">http://leafletjs.com/</a></li>
<li><a href="https://github.com/Leaflet/Leaflet.draw">https://github.com/Leaflet/Leaflet.draw</a></li>
</ul>
<p>Initializing the global namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>window.Pica <span class="keyword">or</span>= {} 

window.Pica ||= {}

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Events</span></span>

  <span class="literal">on</span>: (event, callback) -&gt;
    <span class="property">@events</span> ||= {}
    <span class="property">@events</span>[event] ||= []
    <span class="property">@events</span>[event].push callback

  <span class="literal">off</span>: (event, callback) -&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> <span class="property">@events</span>?

    <span class="keyword">if</span> event?
      <span class="keyword">if</span> <span class="property">@events</span>[event]?
        <span class="keyword">if</span> callback?
          <span class="keyword">for</span> eventCallback, index <span class="keyword">in</span> <span class="property">@events</span>[event]
            <span class="keyword">if</span> eventCallback == callback
              <span class="property">@events</span>[event].splice(index, <span class="number">1</span>)
              index -= <span class="number">1</span>
        <span class="keyword">else</span>
          <span class="keyword">delete</span> <span class="property">@events</span>[event]
    <span class="keyword">else</span>
      <span class="property">@events</span> = []

  trigger: (event, args) -&gt;
    <span class="keyword">if</span> <span class="property">@events</span>? &amp;&amp; <span class="property">@events</span>[event]?
      <span class="keyword">for</span> callback <span class="keyword">in</span> <span class="property">@events</span>[event]
        callback.apply(@, [].concat(args))

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Model</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Events</span></span>
  url: () -&gt;

  get: (attribute) -&gt;
    <span class="property">@attributes</span> ?= {}
    <span class="property">@attributes</span>[attribute]

  set: (attribute, value) -&gt;
    <span class="property">@attributes</span> ?= {}
    <span class="property">@attributes</span>[attribute] = value
    <span class="property">@trigger</span>(<span class="string">'change'</span>)

  sync: (options = {}) -&gt;
    callback = options.success || () -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Extend callback to add returned data as model attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.<span class="function"><span class="title">success</span></span> = (data, textStatus, jqXHR) =&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>data = JSON.parse(data) unless &#39;object&#39; == typeof data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> data.id?
        <span class="property">@parse</span>(data)
        <span class="property">@trigger</span>(<span class="string">'sync'</span>, @)

      callback(@, textStatus, jqXHR)

    <span class="keyword">if</span> options.type == <span class="string">'post'</span> <span class="keyword">or</span> options.type == <span class="string">'put'</span>
      data = <span class="property">@attributes</span>
      data = JSON.stringify(data) <span class="keyword">if</span> options.type == <span class="string">'post'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Send nothing for delete, and set contentType,
otherwise JQuery will try to parse it on return.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> options.type == <span class="string">'delete'</span>
      data = <span class="literal">null</span>

    $.ajax(
      $.extend(
        options,
        contentType: <span class="string">"application/json"</span>
        dataType: <span class="string">"json"</span>
        data: data
      )
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Parse the data that is returned from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parse: (data) -&gt;
    <span class="keyword">for</span> attr, val <span class="keyword">of</span> data
      <span class="property">@set</span>(attr, val)

  save: (options = {}) =&gt;
    <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'id'</span>)?
      options.url = <span class="keyword">if</span> <span class="property">@url</span>().read? <span class="keyword">then</span> <span class="property">@url</span>().read <span class="keyword">else</span> <span class="property">@url</span>()
      options.type = <span class="string">'put'</span>
    <span class="keyword">else</span>
      options.url = <span class="keyword">if</span> <span class="property">@url</span>().create? <span class="keyword">then</span> <span class="property">@url</span>().create <span class="keyword">else</span> <span class="property">@url</span>()
      options.type = <span class="string">'post'</span>
    sync = <span class="property">@sync</span>(options)
    sync.done =&gt; console.log(<span class="string">"saving <span class="subst">#{@constructor.name}</span> <span class="subst">#{@get('id')}</span>"</span>)
    sync
    

  fetch: (options = {}) =&gt;
    options.url = <span class="keyword">if</span> <span class="property">@url</span>().read? <span class="keyword">then</span> <span class="property">@url</span>().read <span class="keyword">else</span> <span class="property">@url</span>()
    console.log(<span class="string">"fetching <span class="subst">#{@constructor.name}</span> <span class="subst">#{@get('id')}</span>"</span>)
    <span class="property">@sync</span>(options)

  destroy: (options = {}) =&gt;
    options.url = <span class="keyword">if</span> <span class="property">@url</span>().read? <span class="keyword">then</span> <span class="property">@url</span>().read <span class="keyword">else</span> <span class="property">@url</span>()
    options.type = <span class="string">'delete'</span>
    originalCallback = options.success
    options.<span class="function"><span class="title">success</span></span> = =&gt;
      <span class="property">@trigger</span>(<span class="string">'delete'</span>)
      console.log(<span class="string">"deleted <span class="subst">#{@constructor.name}</span> <span class="subst">#{@get('id')}</span>"</span>)
      originalCallback() <span class="keyword">if</span> originalCallback
      <span class="property">@off</span>()
    <span class="property">@sync</span>(options)

window.Pica ||= {}
Pica.Models = {}
Pica.Views = {}

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Application</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Events</span></span>
  
  constructor: (<span class="property">@config</span>) -&gt;
    Pica.config = <span class="property">@config</span>

    $.support.cors = <span class="literal">true</span>

    $.ajaxSetup
      headers:
        <span class="string">'X-Magpie-ProjectId'</span>: Pica.config.projectId

    <span class="property">@layers</span> = []
    <span class="property">@fetch</span>()

  newWorkspace: -&gt;
    <span class="property">@currentWorkspace</span> = <span class="keyword">new</span> Pica.Models.Workspace()

  showTileLayers: -&gt;
    <span class="keyword">new</span> Pica.Views.ShowLayersView(app:@)

  fetch: -&gt;
    $.ajax(
      url: <span class="string">"<span class="subst">#{Pica.config.magpieUrl}</span>/projects/<span class="subst">#{Pica.config.projectId}</span>.json"</span>
      type: <span class="string">'get'</span>
      success: <span class="property">@parse</span>
    )

  parse: (data) =&gt;
    <span class="keyword">for</span> attr, val <span class="keyword">of</span> data
      @[attr] = val
    <span class="property">@trigger</span>(<span class="string">'sync'</span>)

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Models</span>.<span class="title">Area</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Model</span></span>
  constructor: (options) -&gt;
    <span class="property">@polygons</span> = []

    <span class="property">@set</span>(<span class="string">'name'</span>, <span class="string">'My Lovely Area'</span>)

  setName: (name) -&gt;
    <span class="property">@set</span>(<span class="string">'name'</span>, name)

  addPolygon: (polygon) -&gt;
    polygon.<span class="literal">on</span>(<span class="string">'requestAreaId'</span>, <span class="property">@getAreaId</span>)
    polygon.<span class="literal">on</span>(<span class="string">'sync'</span>, =&gt; <span class="property">@fetch</span>())
    polygon.<span class="literal">on</span>(<span class="string">'delete'</span>, =&gt; <span class="property">@fetch</span>())
    <span class="property">@polygons</span>.push(polygon)
    <span class="property">@trigger</span>(<span class="string">'addedPolygon'</span>, polygon)</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Passes the area with an ID to success option
or passes an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getAreaId: (options) =&gt;
    <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'id'</span>)?
      options.success(@)
    <span class="keyword">else</span>
      <span class="property">@save</span>(options)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Create a new Pica.Views.NewPolygonView for this area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  drawNewPolygonView: (callbacks) -&gt;
    <span class="property">@createPolygon</span>()
    <span class="keyword">new</span> Pica.Views.NewPolygonView(
      callbacks: callbacks
      polygon: <span class="property">@currentPolygon</span>
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Create a new Pica.Views.NewCircleView for this area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  drawNewCircleView: (callbacks) -&gt;
    <span class="property">@createPolygon</span>()
    <span class="keyword">new</span> Pica.Views.NewCircleView(
      callbacks: callbacks
      polygon: <span class="property">@currentPolygon</span>
    )

  createPolygon: -&gt;
    <span class="property">@currentPolygon</span> = <span class="keyword">new</span> Pica.Models.Polygon()
    <span class="property">@addPolygon</span>(<span class="property">@currentPolygon</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Create a new Pica.Views.UploadPolygonView for this area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  newUploadFileView: (callbacks) -&gt;
    <span class="keyword">new</span> Pica.Views.UploadFileView(
      callbacks: callbacks
      area: @
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>spawns a new ShowAreaPolygonsView for this area</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  newShowAreaPolygonsView: () -&gt;
    <span class="keyword">new</span> Pica.Views.ShowAreaPolygonsView(
      area: @
    )

  url: () -&gt;
    url = Pica.config.magpieUrl
    create: <span class="string">"<span class="subst">#{url}</span>/workspaces/<span class="subst">#{@get('workspace_id')}</span>/areas_of_interest.json"</span>
    read:   <span class="string">"<span class="subst">#{url}</span>/areas_of_interest/<span class="subst">#{@get('id')}</span>.json"</span>

  parse: (data) -&gt;
    <span class="keyword">if</span> data.polygons?
      <span class="property">@polygons</span> = []
      <span class="keyword">for</span> polygonAttributes <span class="keyword">in</span> data.polygons
        polygon = <span class="keyword">new</span> Pica.Models.Polygon(attributes:polygonAttributes)
        <span class="property">@addPolygon</span>(polygon)
      <span class="keyword">delete</span> data.polygons
    <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Remove persisted polygons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      unPersistedPolygons = []
      <span class="keyword">for</span> polygon, index <span class="keyword">in</span> <span class="property">@polygons</span>
        unPersistedPolygons.push(polygon) <span class="keyword">unless</span> polygon.get(<span class="string">'id'</span>)?
      <span class="property">@polygons</span> = unPersistedPolygons

    <span class="keyword">super</span>

  save: (options) =&gt;
    options ||= {}

    <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'workspace_id'</span>)?
      <span class="keyword">super</span> options
    <span class="keyword">else</span>
      <span class="property">@trigger</span>(<span class="string">'requestWorkspaceId'</span>,
        success: (workspace, textStatus, jqXHR) =&gt;
          <span class="property">@set</span>(<span class="string">'workspace_id'</span>, workspace.get(<span class="string">'id'</span>))
          <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'workspace_id'</span>)
            <span class="property">@save</span> options
          <span class="keyword">else</span>
            options.error(
              @,
              {error: <span class="string">"Could not save workspace, so cannot save area"</span>},
              jqXHR
            )
        error: (jqXHR, textStatus, errorThrown) =&gt;
          console.log <span class="string">"Unable to save area:"</span>
          console.log arguments
          console.log jqXHR.status
          console.log jqXHR.statusText
          console.log jqXHR.responseText
          options.error(
            jqXHR,
            textStatus,
            {
              error: <span class="string">"Unable to obtain workspaceId, cannot save area"</span>,
              parentError: errorThrown
            }
          ) <span class="keyword">if</span> options.error?
      )

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Models</span>.<span class="title">Polygon</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Model</span></span>
  constructor: (options = {}) -&gt;
    <span class="property">@attributes</span> = <span class="keyword">if</span> options.attributes? <span class="keyword">then</span> options.attributes <span class="keyword">else</span> {}
    <span class="property">@attributes</span>[<span class="string">'geometry'</span>] ||= {type: <span class="string">'Polygon'</span>}

  isComplete: () -&gt;
    <span class="keyword">return</span> <span class="property">@get</span>(<span class="string">'geometry'</span>).coordinates?

  setGeomFromPoints: (points) -&gt;
    points = <span class="keyword">for</span> point <span class="keyword">in</span> points
      [point.lng, point.lat]

    points.push points[<span class="number">0</span>]

    <span class="property">@set</span>(<span class="string">'geometry'</span>,
      type: <span class="string">'Polygon'</span>
      coordinates: [points]
    )

  setGeomFromCircle: (latLng, radius) -&gt;
    <span class="property">@set</span>(<span class="string">'geometry'</span>,
      type: <span class="string">'Circle'</span>
      coordinates: [latLng.lng, latLng.lat]
      radius: radius
    )

  asLeafletArguments: () -&gt;
    args = []

    <span class="keyword">if</span> (<span class="property">@get</span>(<span class="string">'geometry'</span>).type == <span class="string">'Polygon'</span>)
      latLngs = []
      <span class="keyword">if</span> <span class="property">@isComplete</span>()
        <span class="keyword">for</span> point <span class="keyword">in</span> <span class="property">@get</span>(<span class="string">'geometry'</span>).coordinates[<span class="number">0</span>]
          latLngs.push(<span class="keyword">new</span> L.LatLng(point[<span class="number">1</span>], point[<span class="number">0</span>]))
      args.push latLngs
    <span class="keyword">else</span>
      <span class="keyword">if</span> <span class="property">@isComplete</span>()
        point = <span class="property">@get</span>(<span class="string">'geometry'</span>).coordinates
        args = [<span class="keyword">new</span> L.LatLng(point[<span class="number">1</span>], point[<span class="number">0</span>]), <span class="property">@get</span>(<span class="string">'geometry'</span>).radius]
      <span class="keyword">else</span>
        args = [[], <span class="number">0</span>]

    <span class="keyword">return</span> args

  url: () -&gt;
    url = Pica.config.magpieUrl
    read: <span class="string">"<span class="subst">#{url}</span>/polygons/<span class="subst">#{@get('id')}</span>.json"</span>
    create: <span class="string">"<span class="subst">#{url}</span>/areas_of_interest/<span class="subst">#{@get('area_id')}</span>/polygons.json"</span>

  save: (options) =&gt;
    options ||= {}

    <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'area_id'</span>)?
      <span class="keyword">super</span> options
    <span class="keyword">else</span>
      <span class="property">@trigger</span>(<span class="string">'requestAreaId'</span>,
        success: (area, textStatus, jqXHR) =&gt;
          <span class="property">@set</span>(<span class="string">'area_id'</span>, area.get(<span class="string">'id'</span>))
          <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'area_id'</span>)
            <span class="property">@save</span> options
          <span class="keyword">else</span>
            options.error(
              @,
              {error: <span class="string">"Unable to get area id, so cannot save polygon"</span>},
              jqXHR
            ) <span class="keyword">if</span> options.error?
        error: (jqXHR, textStatus, errorThrown) =&gt;
          console.log <span class="string">"Unable to save polygon:"</span>
          console.log arguments
          console.log jqXHR.status
          console.log jqXHR.statusText
          console.log jqXHR.responseText
          options.error(
            jqXHR,
            textStatus,
            {
              error: <span class="string">"Unable to obtain areaId, cannot save polygon"</span>,
              parentError: errorThrown
            }
          ) <span class="keyword">if</span> options.error?
      )
<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Models</span>.<span class="title">Workspace</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Model</span></span>
  constructor: () -&gt;
    <span class="property">@attributes</span> = {}
    <span class="property">@areas</span> = []

    <span class="property">@currentArea</span> = <span class="keyword">new</span> Pica.Models.Area()
    <span class="property">@addArea</span>(<span class="property">@currentArea</span>)

  url: () -&gt;
    <span class="string">"<span class="subst">#{Pica.config.magpieUrl}</span>/workspaces.json"</span>

  addArea: (area) -&gt;
    area.<span class="literal">on</span>(<span class="string">'requestWorkspaceId'</span>, (options) =&gt;
      <span class="keyword">if</span> <span class="property">@get</span>(<span class="string">'id'</span>)?
        options.success(@)
      <span class="keyword">else</span>
        <span class="property">@save</span>(options)
    )
    <span class="property">@areas</span>.push(area)

  removeArea: (theArea) -&gt;
    id = <span class="property">@areas</span>.indexOf(theArea)
    area = <span class="property">@areas</span>.splice(id, <span class="number">1</span>)[<span class="number">0</span>]
    <span class="keyword">if</span> area.get(<span class="string">'id'</span>)?
      area.destroy()

  setCurrentArea: (theArea) -&gt;
    <span class="keyword">for</span> area <span class="keyword">in</span> <span class="property">@areas</span>
      <span class="keyword">if</span> area == theArea
        <span class="property">@currentArea</span> = area

  setCurrentAreaById: (areaId) -&gt;
    <span class="keyword">for</span> area <span class="keyword">in</span> <span class="property">@areas</span>
      <span class="keyword">if</span> area.get(<span class="string">'id'</span>) == areaId
        <span class="property">@currentArea</span> = area

  save: (options) =&gt;
    <span class="keyword">super</span> options

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Views</span>.<span class="title">NewCircleView</span></span>
  constructor: (options) -&gt;
    <span class="keyword">if</span> options.callbacks?
      <span class="property">@successCallback</span> = options.callbacks.success
      <span class="property">@errorCallback</span> = options.callbacks.error

    <span class="property">@polygon</span> = options.polygon
    <span class="property">@polygon</span>.set(<span class="string">'geometry'</span>, {type:<span class="string">'Circle'</span>})</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Turn on Leaflet.draw polygon tool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@polygonDraw</span> = <span class="keyword">new</span> L.Circle.Draw(Pica.config.map, {})
    <span class="property">@polygonDraw</span>.enable()

    Pica.config.map.<span class="literal">on</span> <span class="string">'draw:circle-created'</span>, (e) =&gt;
      <span class="property">@createPolygon</span> e.circ

  createPolygon: (mapCircle) -&gt;
    <span class="property">@polygon</span>.setGeomFromCircle(mapCircle.getLatLng(), mapCircle.getRadius())
    <span class="property">@polygon</span>.save(
      success: =&gt;
        <span class="property">@close</span>()
        <span class="property">@successCallback</span>() <span class="keyword">if</span> <span class="property">@successCallback</span>?
      error: (xhr, textStatus, errorThrown) =&gt;
        <span class="property">@close</span>()
        <span class="property">@errorCallback</span>.apply(@, arguments) <span class="keyword">if</span> <span class="property">@errorCallback</span>?
    )

  close: () -&gt;
    <span class="property">@polygonDraw</span>.disable()
    Pica.config.map.<span class="literal">off</span>(<span class="string">'draw:circle-created'</span>)

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Views</span>.<span class="title">NewPolygonView</span></span>
  constructor: (options) -&gt;
    <span class="keyword">if</span> options.callbacks?
      <span class="property">@successCallback</span> = options.callbacks.success
      <span class="property">@errorCallback</span> = options.callbacks.error

    <span class="property">@polygon</span> = options.polygon</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Turn on Leaflet.draw polygon tool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@polygonDraw</span> = <span class="keyword">new</span> L.Polygon.Draw(Pica.config.map, {})
    <span class="property">@polygonDraw</span>.enable()

    Pica.config.map.<span class="literal">on</span> <span class="string">'draw:poly-created'</span>, (e) =&gt;
      mapPolygon = e.poly
      <span class="property">@createPolygon</span> mapPolygon

  createPolygon: (mapPolygon) -&gt;
    <span class="property">@polygon</span>.setGeomFromPoints(mapPolygon.getLatLngs())
    <span class="property">@polygon</span>.save(
      success: () =&gt;
        <span class="property">@close</span>()
        <span class="property">@successCallback</span>() <span class="keyword">if</span> <span class="property">@successCallback</span>?
      error: (xhr, textStatus, errorThrown) =&gt;
        <span class="property">@close</span>()
        <span class="property">@errorCallback</span>.apply(@, arguments) <span class="keyword">if</span> <span class="property">@errorCallback</span>?
    )

  close: () -&gt;
    <span class="property">@polygonDraw</span>.disable()
    Pica.config.map.<span class="literal">off</span>(<span class="string">'draw:poly-created'</span>)

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Views</span>.<span class="title">ShowAreaPolygonsView</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Events</span></span>
  constructor: (options) -&gt;
    <span class="property">@area</span> = options.area
    <span class="property">@polysObserved</span> = []
    <span class="property">@mapPolygons</span> = []
    <span class="property">@area</span>.<span class="literal">on</span>(<span class="string">'sync'</span>, <span class="property">@render</span>)
    <span class="property">@area</span>.<span class="literal">on</span>(<span class="string">'addedPolygon'</span>, <span class="property">@addPolygon</span>)
    <span class="property">@render</span>()

  render: =&gt;
    <span class="property">@removeAllPolygonsAndBindings</span>()

    <span class="keyword">for</span> polygon <span class="keyword">in</span> <span class="property">@area</span>.polygons
      <span class="keyword">continue</span> <span class="keyword">unless</span> polygon.isComplete()</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Method which emulates calling &#39;new theConstructor.apply(@, args)&#39;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="function"><span class="title">newObject</span></span> = (theConstructor, args)-&gt;
        <span class="function"><span class="title">Wrapper</span></span> = (args) -&gt;
          <span class="keyword">return</span> theConstructor.apply(@, args)
        Wrapper:: = theConstructor::
        <span class="keyword">return</span> <span class="keyword">new</span> Wrapper(args)
      mapPolygon = newObject(L[polygon.get(<span class="string">'geometry'</span>).type],
        polygon.asLeafletArguments()).addTo(Pica.config.map)

      polygon.<span class="literal">on</span>(<span class="string">'delete'</span>, (=&gt;
        thatMapPolygon = mapPolygon
        <span class="keyword">return</span> =&gt;
          <span class="property">@removeMapPolygonAndBindings</span>(thatMapPolygon)
      )())

      mapPolygon.<span class="literal">on</span>(<span class="string">'click'</span>, (=&gt;
        thatPolygon = polygon
        thatMapPolygon = mapPolygon
        <span class="keyword">return</span> (event) =&gt;
          <span class="property">@triggerPolyClick</span>(thatPolygon, event, thatMapPolygon)
      )())

      <span class="property">@mapPolygons</span>.push(mapPolygon)

  addPolygon: (polygon) =&gt;
    polygon.<span class="literal">on</span>(<span class="string">'change'</span>, <span class="property">@render</span>)
    <span class="property">@polysObserved</span>.push(polygon)

  close: -&gt;
    <span class="property">@removeAllPolygonsAndBindings</span>()
    <span class="property">@area</span>.<span class="literal">off</span>(<span class="string">'sync'</span>, <span class="property">@render</span>)
    <span class="property">@area</span>.<span class="literal">off</span>(<span class="string">'addedPolygon'</span>, <span class="property">@addPolygon</span>)
    <span class="keyword">for</span> polygon <span class="keyword">in</span> <span class="property">@polysObserved</span>
      polygon.<span class="literal">off</span>(<span class="string">'change'</span>, <span class="property">@render</span>)

  removeAllPolygonsAndBindings: -&gt;
    <span class="keyword">while</span> mapPolygon = <span class="property">@mapPolygons</span>.shift()
      <span class="property">@removeMapPolygonAndBindings</span>(mapPolygon)

  removeMapPolygonAndBindings: (mapPolygon) -&gt;
    mapPolygon.<span class="literal">off</span>(<span class="string">'click'</span>, <span class="property">@triggerPolyClicked</span>)
    Pica.config.map.removeLayer mapPolygon

  triggerPolyClick: (polygon, event, mapPolygon) =&gt;
    <span class="property">@trigger</span>(<span class="string">'polygonClick'</span>, [polygon, event, mapPolygon])

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Views</span>.<span class="title">ShowLayersView</span></span>
  constructor: (options) -&gt;
    <span class="property">@app</span> = options.app
    <span class="property">@app</span>.<span class="literal">on</span>(<span class="string">'sync'</span>, <span class="property">@render</span>)
    <span class="property">@tileLayers</span> = []
    <span class="property">@render</span>()

  render: =&gt;
    <span class="property">@removeTileLayers</span>()
    <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="property">@app</span>.layers
      tileLayer = <span class="keyword">new</span> L.TileLayer(layer.tile_url)
      <span class="property">@tileLayers</span>.push(tileLayer)
      tileLayer.addTo(<span class="property">@app</span>.config.map)

  removeTileLayers: =&gt;
    <span class="keyword">for</span> tileLayer <span class="keyword">in</span> <span class="property">@tileLayers</span>
      <span class="property">@app</span>.map.removeLayer(tileLayer)

  close: -&gt;
    <span class="property">@removeTileLayers</span>()
    <span class="property">@app</span>.<span class="literal">off</span>(<span class="string">'sync'</span>, <span class="property">@render</span>)

<span class="class"><span class="keyword">class</span> <span class="title">Pica</span>.<span class="title">Views</span>.<span class="title">UploadFileView</span> <span class="keyword">extends</span> <span class="title">Pica</span>.<span class="title">Events</span></span>
  constructor: (options) -&gt;
    <span class="keyword">if</span> options.callbacks?
      <span class="property">@successCallback</span> = options.callbacks.success
      <span class="property">@errorCallback</span> = options.callbacks.error
    <span class="property">@area</span> = options.area
    <span class="property">@el</span> = document.createElement(<span class="string">"div"</span>)

    <span class="property">@area</span>.getAreaId(success:<span class="property">@render</span>)

  render: =&gt;
    formFrame = document.createElement(<span class="string">'iframe'</span>)
    formFrame.src = <span class="string">"<span class="subst">#{Pica.config.magpieUrl}</span>/areas_of_interest/<span class="subst">#{@area.get('id')}</span>/polygons/new_upload_form/"</span>
    formFrame.className = <span class="string">"pica-upload-form"</span>
    <span class="property">@el</span>.appendChild(formFrame)
    window.addEventListener(<span class="string">"message"</span>, <span class="property">@onUploadComplete</span>, <span class="literal">false</span>)

  onUploadComplete: (event) =&gt;
    <span class="keyword">if</span> event.origin == Pica.config.magpieUrl <span class="keyword">and</span> event.data.polygonImportStatus?
      <span class="keyword">if</span> event.data.polygonImportStatus == <span class="string">'Successful import'</span> <span class="keyword">and</span> <span class="property">@successCallback</span>?
        <span class="property">@successCallback</span>(event.data.polygonImportStatus, event.data.importMessages)
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="property">@errorCallback</span>?
        <span class="property">@errorCallback</span>(event.data.polygonImportStatus, event.data.importMessages)
      <span class="property">@close</span>()

  close: -&gt;
    window.removeEventListener(<span class="string">"message"</span>, <span class="property">@onUploadComplete</span>)
    $(<span class="property">@el</span>).remove()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
